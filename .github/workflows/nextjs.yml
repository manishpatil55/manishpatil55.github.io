# Portfolio Versioning Workflow
# Builds and deploys multiple portfolio versions to GitHub Pages
#
# Structure:
#   - All versions live in versions/v1/, versions/v2/, etc.
#   - versions.json defines which version is "active" (shown at root)
#   - Each version is also available at its own path (/v1, /v2, etc.)
#
# To change which version shows at root: edit "activeVersion" in versions.json

name: Deploy Portfolio Versions to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: '**/package-lock.json'

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Create final output directory
        run: mkdir -p final-out

      - name: Read active version from config
        id: config
        run: |
          ACTIVE_VERSION=$(cat versions.json | jq -r '.activeVersion')
          echo "active_version=$ACTIVE_VERSION" >> $GITHUB_OUTPUT
          echo "Active version is: $ACTIVE_VERSION"

      # ========== BUILD V1 ==========
      - name: Install v1 dependencies
        working-directory: versions/v1
        run: npm ci

      - name: Build v1 (with /v1 basePath)
        working-directory: versions/v1
        run: npx next build

      - name: Copy v1 output
        run: |
          mkdir -p final-out/v1
          cp -r versions/v1/out/* final-out/v1/

      # ========== BUILD V2 ==========
      - name: Install v2 dependencies
        working-directory: versions/v2
        run: npm ci

      - name: Build v2 (with /v2 basePath)
        working-directory: versions/v2
        run: npm run build

      - name: Copy v2 output
        run: |
          mkdir -p final-out/v2
          cp -r versions/v2/out/* final-out/v2/

      # ========== BUILD ACTIVE VERSION FOR ROOT ==========
      - name: Build active version for root
        run: |
          ACTIVE="${{ steps.config.outputs.active_version }}"
          echo "Building $ACTIVE for root..."
          cd versions/$ACTIVE
          
          # Create a temporary config without basePath for root
          if [ -f "next.config.js" ]; then
            cat > next.config.root.js << 'EOF'
          /** @type {import('next').NextConfig} */
          const nextConfig = {
            output: 'export',
            images: { unoptimized: true },
            compiler: { styledComponents: true },
          };
          module.exports = nextConfig;
          EOF
            mv next.config.js next.config.versioned.js
            mv next.config.root.js next.config.js
          elif [ -f "next.config.mjs" ]; then
            cat > next.config.root.mjs << 'EOF'
          /** @type {import('next').NextConfig} */
          const nextConfig = {
            output: 'export',
            images: { unoptimized: true },
          };
          export default nextConfig;
          EOF
            mv next.config.mjs next.config.versioned.mjs
            mv next.config.root.mjs next.config.mjs
          fi
          
          rm -rf out .next
          npm run build

      - name: Copy active version to root
        run: |
          ACTIVE="${{ steps.config.outputs.active_version }}"
          cp -r versions/$ACTIVE/out/* final-out/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./final-out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
